{% extends "store/base.html" %}

{% block title %}
Checkout
{% endblock %}

{% block content %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<h2>Complete Your Payment</h2>
<button id="rzp-button" class="btn btn-primary">Pay Now</button>
<div id="payment-loader" style="display: none;">
    <p>Processing payment...</p>
</div>

<script>
    var options = {
        key: "{{ razorpay_api_key }}",
        amount: "{{ order_amount }}",
        currency: "INR",
        order_id: "{{ razorpay_order_id }}",
        handler: function (response) {
            document.getElementById('payment-loader').style.display = 'block';
            document.getElementById('rzp-button').disabled = true;

            fetch('/orders/payment/fverify/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(response)
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('payment-loader').style.display = 'none';
                document.getElementById('rzp-button').disabled = false;

                if (data.status === "success") {
                    alert("Payment Successful!");
                    window.location.href = '/orders/order_created/{{ order.id }}/';
                } else {
                    alert("Payment Failed! Please try again.");
                }
            })
            .catch(error => {
                document.getElementById('payment-loader').style.display = 'none';
                document.getElementById('rzp-button').disabled = false;
                alert("Error verifying payment! Please try again.");
            });
        },
        prefill: {
            name: "{{ order.first_name }} {{ order.last_name }}",
            email: "{{ order.email }}"
        },
        notes: {
            order_id: "{{ razorpay_order_id }}"
        },
        theme: {
            color: "#F37254"
        }
    };


    var rzp = new Razorpay(options);

    document.getElementById('rzp-button').onclick = function(e) {
        rzp.open();
        e.preventDefault();
    };

</script>

{% endblock %}
